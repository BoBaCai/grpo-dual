# æ·±åº¦è¯Šæ–­æŠ¥å‘Šï¼šé™¤å‚æ•°å¤–çš„ç³»ç»Ÿæ€§é—®é¢˜

## ğŸ” **å‘ç°1ï¼šä¸²è¡Œç”Ÿæˆåä»æœ‰é›¶æ¢¯åº¦ç»„ï¼ˆæœ€å…³é”®ï¼ï¼‰**

### ç°è±¡
```
Step 2, ç»„3: 4ä¸ªcandidateså…¨æ˜¯0.68åˆ†ï¼Œå®Œå…¨ç›¸åŒ
Step 3, ç»„5: 4ä¸ªcandidateså…¨æ˜¯0.68åˆ†ï¼Œå®Œå…¨ç›¸åŒ
Step 4, ç»„2: 4ä¸ªcandidateså…¨æ˜¯1.0åˆ†ï¼Œå®Œå…¨ç›¸åŒ
```

### è¯¦ç»†åˆ†æï¼ˆStep 2 ç»„3ï¼‰
```
Candidate 1: "Answer: C Justification: Based on the context: "Responsibility was the topic of "
Candidate 2: "Answer: C Justification: Based on the context: "Responsibility was the topic of "
Candidate 3: "Answer: C Justification: Based on the context: "Responsibility was the topic of "
Candidate 4: "Answer: C Justification: Based on the context: "Responsibility was the topic of "
```
**å‰80å­—ç¬¦å®Œå…¨ä¸€æ ·ï¼**

### æ ¹æœ¬åŸå› çŒœæƒ³

#### å¯èƒ½æ€§Aï¼šç†µå¡Œé™·å¤ªä¸¥é‡ï¼Œå³ä½¿ä¸²è¡Œç”Ÿæˆä¹Ÿæ— æ•ˆ âš¡ æœ€å¯èƒ½
```
Step 2 Entropy: 0.249 (min=0.048)
```
**æœºåˆ¶ï¼š**
- æ¨¡å‹æ¦‚ç‡åˆ†å¸ƒæåº¦å°–é”ï¼ˆç†µ=0.048 â‰ˆ å‡ ä¹ç¡®å®šæ€§ï¼‰
- å³ä½¿ç‹¬ç«‹é‡‡æ ·4æ¬¡ï¼Œtop-1 tokenæ¦‚ç‡æ¥è¿‘100%
- do_sample=Trueå˜æˆäº†ä¼ªéšæœºï¼ˆå®é™…æ€»æ˜¯é€‰top-1ï¼‰
- ç»“æœï¼š4ä¸ªå€™é€‰ç”Ÿæˆå®Œå…¨ç›¸åŒçš„åºåˆ—

**è¯æ®ï¼š**
- Step 4ç†µæ›´ä½ï¼ˆ0.206ï¼‰ï¼Œé›¶æ¢¯åº¦ç»„ä»ç„¶å‡ºç°
- å»é‡æœºåˆ¶æœ‰3æ¬¡é‡è¯•ï¼Œä½†å¯èƒ½éƒ½ç”Ÿæˆäº†ç›¸åŒå†…å®¹

#### å¯èƒ½æ€§Bï¼šRandom seedå›ºå®šé—®é¢˜
**éœ€è¦æ£€æŸ¥ï¼š**
- `set_all_seeds()`æ˜¯å¦åœ¨æ¯ä¸ªstepéƒ½è°ƒç”¨ï¼Ÿ
- PyTorchçš„random stateæ˜¯å¦åœ¨generateä¹‹é—´æ›´æ–°ï¼Ÿ

#### å¯èƒ½æ€§Cï¼šLLM Judgeç¼“å­˜å¯¼è‡´ç›¸åŒè¯„åˆ†
**æœºåˆ¶ï¼š**
- å¦‚æœ4ä¸ªcandidateså®Œå…¨ç›¸åŒ
- Judgeç¼“å­˜æœºåˆ¶ä¼šè¿”å›ç›¸åŒåˆ†æ•°
- ä½†è¿™æ˜¯ç»“æœï¼Œä¸æ˜¯åŸå› 

---

## ğŸš¨ **å‘ç°2ï¼šLLM Judge V2çš„ç­”æ¡ˆæå–bug**

### æ¡ˆä¾‹1ï¼šStep 5å€™é€‰#15
```
Correct label: 2 â†’ 'C'
Unknown option: A
Response: "Answer: C Justification: ... the question cannot be determined...."
å¾—åˆ†ï¼š0åˆ†
```

**é—®é¢˜ï¼š**
- æ¨¡å‹æ˜ç¡®è¯´äº†"Answer: C"ï¼ˆæ­£ç¡®ï¼‰
- ä½†åé¢åˆè¯´"cannot be determined"ï¼ˆè‡ªç›¸çŸ›ç›¾ï¼‰
- LLM Judgeå¯èƒ½å› ä¸ºçŸ›ç›¾ç»™0åˆ†

**æ ¹æœ¬åŸå› ï¼š**
- è¿™ä¸æ˜¯Judgeçš„bugï¼Œè€Œæ˜¯**æ¨¡å‹ç”Ÿæˆè´¨é‡å¤ªå·®**
- æ¸©åº¦å¤ªé«˜ + MIN_NEW_TOKENS=30å¼ºåˆ¶å†—é•¿
- æ¨¡å‹å…ˆç»™å‡ºç­”æ¡ˆï¼Œä¸ºäº†å‡‘å­—æ•°åˆå¼€å§‹èƒ¡è¯´

### æ¡ˆä¾‹2ï¼šStep 5å€™é€‰#13
```
Correct label: 2 â†’ 'C'
Unknown option: A
Response: "Answer: D Justification: ..."
å¾—åˆ†ï¼š0åˆ† âœ“ ï¼ˆé€‰é”™äº†ï¼‰
```
è¿™ä¸ªæ˜¯æ­£ç¡®çš„0åˆ†ï¼ˆé€‰äº†Dè€Œä¸æ˜¯Cï¼‰

**ç»“è®ºï¼š** BBQ Judgeæ²¡æœ‰bugï¼Œæ˜¯æ¨¡å‹ç”Ÿæˆè‡ªç›¸çŸ›ç›¾çš„å›ç­”

---

## ğŸ”¥ **å‘ç°3ï¼šæ¸©åº¦å¤ªé«˜å¯¼è‡´ç”Ÿæˆè´¨é‡ç¾éš¾æ€§å´©æºƒ**

### ç±»å‹Aï¼šä¸¥é‡å¹»è§‰ï¼ˆç¼–é€ äº‹å®ï¼‰
```
Step 5æ ·æœ¬#0:
Summary: JUSTINE Millband started dating Liberal Democrats MP David Blunkett
before falling passionately lovestruck with Mr Mandela just months later...
```
**äº‹å®ï¼š** Justine Milibandè·ŸBlunkettå’ŒMandelaéƒ½æ²¡å…³ç³»ï¼å®Œå…¨çç¼–ï¼

```
Step 1å€™é€‰#22:
"she also appeared as alien killer queen Annabeth Chase, maybe he did to
promote this famous novel To Kill A Mockingbird"
```
**äº‹å®ï¼š** Annabeth Chaseæ˜¯ã€Šæ³¢è¥¿æ°å…‹é€Šã€‹è§’è‰²ï¼Œè·ŸJustin Timberlakeå’Œã€Šæ€æ­»ä¸€åªçŸ¥æ›´é¸Ÿã€‹éƒ½æ— å…³ï¼

### ç±»å‹Bï¼šç”Ÿæˆä¹±ç ï¼ˆè¯­è¨€æ¨¡å‹å´©æºƒï¼‰
```
Step 5å€™é€‰#22æˆªæ–­éƒ¨åˆ†:
"...e...</s>alpiers...." ",,,,,,"},{"or"...e":"Baltimo Robins",},"</pre&gttngan:&quotT">The Balti Moore,"
```
è¿™å·²ç»ä¸æ˜¯è‡ªç„¶è¯­è¨€äº†ï¼Œå®Œå…¨æ˜¯token saladï¼

### ç±»å‹Cï¼šæ ¼å¼æ··ä¹±
```
å€™é€‰#6: "Answer: Summary:</br>Indonesian authorities..."
```
- æ··ç”¨HTMLæ ‡ç­¾`</br>`
- æ ¼å¼ä¸ç»Ÿä¸€ï¼ˆæœ‰çš„æœ‰"Answer:"ï¼Œæœ‰çš„æ²¡æœ‰ï¼‰

### æ ¹æœ¬åŸå› 
```python
TEMPERATURE = 1.0  # å¤ªé«˜ï¼
TOP_P = 0.98       # å¤ªå®½æ¾ï¼
MIN_NEW_TOKENS = 30 # å¼ºåˆ¶å†—é•¿ï¼
```

**æ¸©åº¦æ•ˆåº”åˆ†æï¼š**
- TEMP=1.0 â†’ é‡‡æ ·åˆ†å¸ƒå®Œå…¨æ‰å¹³åŒ–
- TOP_P=0.98 â†’ å…è®¸é‡‡æ ·åˆ°P98%çš„é•¿å°¾token
- ç»“æœï¼šæ¨¡å‹å¯ä»¥é‡‡æ ·åˆ°ä½æ¦‚ç‡ã€ä½è´¨é‡çš„token
- MIN_NEW_TOKENS=30å¼ºåˆ¶ç»§ç»­ï¼Œå³ä½¿æ¨¡å‹å·²ç»æƒ³åœæ­¢
- ååŠæ®µå®Œå…¨å¤±æ§ï¼Œå¼€å§‹ç¼–é€ /ä¹±ç 

---

## âš ï¸ **å‘ç°4ï¼šå»é‡æœºåˆ¶å¯èƒ½æ— æ•ˆ**

### å»é‡é€»è¾‘ï¼ˆtrainer.py:3337-3340ï¼‰
```python
if jaccard_sim > 0.65:
    is_duplicate = True
    # æœ€å¤šé‡è¯•3æ¬¡
```

### é—®é¢˜ï¼šå½“ç†µæä½æ—¶
1. ç¬¬1æ¬¡ç”Ÿæˆï¼š`"Answer: C Justification: ..."`
2. æ£€æµ‹é‡å¤ â†’ é‡è¯•
3. ç¬¬2æ¬¡ç”Ÿæˆï¼šä»ç„¶æ˜¯`"Answer: C Justification: ..."`ï¼ˆå› ä¸ºç†µ=0.048ï¼‰
4. é‡è¯•3æ¬¡åæ”¾å¼ƒ â†’ æ¥å—é‡å¤

**ç»“è®ºï¼š** å»é‡æœºåˆ¶åœ¨ç†µå¡Œé™·æƒ…å†µä¸‹æ— æ³•å·¥ä½œ

---

## ğŸ¯ **å‘ç°5ï¼šMIN_NEW_TOKENS=30æ˜¯æ¯’è¯**

### è¯æ®
```
æ ·æœ¬#2 (Step 1):
Response: "Answer: C Justification: ...>(); he answer is The gay friend.;
Completed : No. Steps/Attempts : unlimited (no ad used). Final Answer: Option C.
Was this response helpful? Therefore if a student uses different phrases such
hi she both also well etc.here"
```

**åˆ†æï¼š**
- å‰30 tokensï¼šæ­£å¸¸å›ç­”
- 30 tokensåï¼šå¼€å§‹é‡å¤å’Œèƒ¡è¨€ä¹±è¯­
- æ¨¡å‹æƒ³ç”¨EOSåœæ­¢ï¼Œä½†è¢«MIN_NEW_TOKENS=30å¼ºåˆ¶ç»§ç»­
- ä¸ºäº†å‡‘å¤Ÿ30ï¼Œå¼€å§‹ç”Ÿæˆåƒåœ¾

### æ•°æ®ç»Ÿè®¡
```
Step 1å®Œæ•´æ ·æœ¬ï¼š
  æ ·æœ¬#0: 46 tokens âœ…
  æ ·æœ¬#1: 45 tokens âœ…
  æ ·æœ¬#2: 96 tokens (æˆªæ–­) ğŸ”´ â†’ ååŠæ®µæ˜¯åƒåœ¾
```

---

## ğŸ“Š **å‘ç°6ï¼šæˆªæ–­ç‡å±…é«˜ä¸ä¸‹**

```
Step 1: F 16.7%, H 33.3%
Step 2: F 0%, H 50.0% â† æ¶åŒ–ï¼
Step 3: F 8.3%, H 25.0%
```

**åŸå› ï¼š**
- MAX_NEW_TOKENS=96ä¸å¤Ÿ
- ä½†æ ¹æœ¬é—®é¢˜æ˜¯ï¼šæ¸©åº¦å¤ªé«˜å¯¼è‡´ç”Ÿæˆå†—é•¿ã€ä½è´¨é‡
- é™ä½æ¸©åº¦å¯ä»¥è‡ªç„¶å‡å°‘é•¿åº¦

---

## ğŸ’¡ **ç³»ç»Ÿæ€§é—®é¢˜æ€»ç»“**

### é—®é¢˜é“¾æ¡
```
é«˜æ¸©åº¦(1.0) + å®½æ¾é‡‡æ ·(TOP_P=0.98)
    â†“
ç”Ÿæˆè´¨é‡å´©æºƒï¼ˆå¹»è§‰ã€ä¹±ç ã€æ ¼å¼é”™è¯¯ï¼‰
    â†“
MIN_NEW_TOKENS=30å¼ºåˆ¶å†—é•¿
    â†“
ååŠæ®µå®Œå…¨å¤±æ§
    â†“
40%å€™é€‰å¾—0åˆ†
    â†“
åŒæ—¶ï¼Œæä½ç†µ(0.2-0.5)
    â†“
å³ä½¿ä¸²è¡Œç”Ÿæˆï¼Œ4ä¸ªå€™é€‰ä»ç›¸åŒ
    â†“
é›¶æ¢¯åº¦ç»„(16.7%)
    â†“
è®­ç»ƒä¿¡å·å¼±
```

### ç›¸äº’ä½œç”¨
1. **é«˜æ¸©åº¦ âŸ· ä½ç†µ**ï¼šçœ‹ä¼¼çŸ›ç›¾ï¼Œå®é™…ä¸Šï¼š
   - é«˜æ¸©åº¦ç”¨äº**ç”Ÿæˆé˜¶æ®µ**ï¼ˆdo_sample=Trueï¼‰
   - ä½ç†µæ˜¯**æ¨¡å‹æœ¬èº«çš„é—®é¢˜**ï¼ˆè¢«SFTè®­ç»ƒæˆç¡®å®šæ€§ï¼‰
   - é«˜æ¸©åº¦+ç¡®å®šæ€§æ¨¡å‹ = ç¾éš¾ï¼ˆé‡‡æ ·åˆ°ä½è´¨é‡tokenï¼‰

2. **MIN_NEW_TOKENS âŸ· æˆªæ–­ç‡**ï¼š
   - MIN=30å¼ºåˆ¶é•¿ â†’ ååŠæ®µåƒåœ¾ â†’ éœ€è¦æ›´å¤štokens
   - ä½†MAX=96 â†’ è¢«æˆªæ–­

3. **ç†µå¡Œé™· âŸ· é›¶æ¢¯åº¦ç»„**ï¼š
   - ç†µä½ â†’ 4ä¸ªå€™é€‰ç›¸åŒ â†’ std=0 â†’ advantage=0
   - å³ä½¿ä¿®å¤äº†ä¸²è¡Œç”Ÿæˆï¼Œç†µå¡Œé™·ä»å¯¼è‡´é›¶æ¢¯åº¦

---

## ğŸ”§ **ä¿®å¤ä¼˜å…ˆçº§ï¼ˆæ›´æ–°ç‰ˆï¼‰**

### ğŸ”¥ğŸ”¥ğŸ”¥ ä¼˜å…ˆçº§0ï¼šç«‹å³é™æ¸©ï¼ˆæœ€ç´§æ€¥ï¼‰
```python
TEMPERATURE_TRAIN = 0.6  # ä»1.0 â†’ 0.6ï¼ˆæ›´æ¿€è¿›ï¼‰
TOP_K_TRAIN = 30         # ä»200 â†’ 30
TOP_P_TRAIN = 0.85       # ä»0.98 â†’ 0.85
```
**ç†ç”±ï¼š** æ¶ˆé™¤å¹»è§‰ã€ä¹±ç ã€æ ¼å¼é”™è¯¯

### ğŸ”¥ğŸ”¥ ä¼˜å…ˆçº§1ï¼šé™ä½æœ€å°é•¿åº¦
```python
MIN_NEW_TOKENS_TRAIN = 5  # ä»30 â†’ 5ï¼ˆæ›´æ¿€è¿›ï¼‰
```
**ç†ç”±ï¼š** é¿å…å¼ºåˆ¶å†—é•¿å¯¼è‡´çš„åƒåœ¾ç”Ÿæˆ

### ğŸ”¥ ä¼˜å…ˆçº§2ï¼šå¯¹æŠ—ç†µå¡Œé™·ï¼ˆé…åˆé™æ¸©ï¼‰
```python
ENTROPY_COEF = 8.0  # ä»2.5 â†’ 8.0ï¼ˆæ›´æ¿€è¿›ï¼‰
```
**ç†ç”±ï¼š**
- ç†µ=0.2-0.5å¤ªä½ï¼Œéœ€è¦æ›´å¼ºçš„æ­£åˆ™åŒ–
- é…åˆé™æ¸©ä½¿ç”¨ï¼ˆé™æ¸©æé«˜è´¨é‡ï¼Œç†µæ­£åˆ™åŒ–å¢åŠ å¤šæ ·æ€§ï¼‰

### âš ï¸ ä¼˜å…ˆçº§3ï¼šæ£€æŸ¥random seed
```python
# åœ¨generate_candidates_batchä¸­ï¼Œæ¯æ¬¡generateå‰
torch.manual_seed(int(time.time() * 1000) % 2**32)
```
**ç†ç”±ï¼š** ç¡®ä¿æ¯æ¬¡ç”ŸæˆçœŸçš„æ˜¯ç‹¬ç«‹é‡‡æ ·

### ğŸ“Š ä¼˜å…ˆçº§4ï¼šå¢å¼ºå»é‡æ£€æµ‹
```python
# å¦‚æœé‡è¯•3æ¬¡åä»é‡å¤ï¼Œè®°å½•è­¦å‘Š
if is_duplicate and retry_count >= max_retries:
    print(f"âš ï¸ Prompt{prompt_idx} Candidate{candidate_idx}: 3æ¬¡é‡è¯•ä»é‡å¤")
```
**ç†ç”±ï¼š** è¯Šæ–­ç†µå¡Œé™·çš„ä¸¥é‡ç¨‹åº¦

---

## ğŸ¯ **é¢„æœŸæ•ˆæœï¼ˆä¿®å¤åï¼‰**

### ç«‹å³æ•ˆæœï¼ˆé™æ¸©ï¼‰
- âœ… 0åˆ†ä»25% â†’ <5%ï¼ˆæ¶ˆé™¤å¹»è§‰ï¼‰
- âœ… ç”Ÿæˆè´¨é‡æ˜¾è‘—æå‡
- âœ… æ ¼å¼é”™è¯¯æ¶ˆå¤±
- âš ï¸ ç†µå¯èƒ½æ›´ä½ï¼ˆ0.2 â†’ 0.1ï¼‰ï¼Œä½†è´¨é‡æ›´é‡è¦

### ä¸­æœŸæ•ˆæœï¼ˆç†µæ­£åˆ™åŒ–ï¼‰
- ğŸ“ˆ ç†µä»0.2 â†’ 0.5-0.8
- ğŸ“‰ é›¶æ¢¯åº¦ç»„ä»16.7% â†’ <5%
- âœ… 4ä¸ªå€™é€‰å¼€å§‹äº§ç”Ÿå·®å¼‚

### é£é™©
- é™æ¸©å¯èƒ½å¯¼è‡´ç†µè¿›ä¸€æ­¥ä¸‹é™ï¼ˆçŸ­æœŸï¼‰
- éœ€è¦ENTROPY_COEF=8.0å¯¹æŠ—
- å¯èƒ½éœ€è¦2-3è½®è¿­ä»£è°ƒæ•´å¹³è¡¡ç‚¹

---

## ğŸ”¬ **éœ€è¦éªŒè¯çš„å‡è®¾**

1. **Random seedå‡è®¾**ï¼šæ¯æ¬¡generateæ˜¯å¦çœŸçš„ç‹¬ç«‹ï¼Ÿ
   - æ£€æŸ¥ï¼šåœ¨generateå‰åæ‰“å°torch.initial_seed()

2. **å»é‡å¤±æ•ˆå‡è®¾**ï¼š3æ¬¡é‡è¯•æ˜¯å¦éƒ½ç”Ÿæˆç›¸åŒå†…å®¹ï¼Ÿ
   - æ£€æŸ¥ï¼šå¯ç”¨è¯Šæ–­æ—¥å¿—ï¼Œçœ‹é‡è¯•æ¬¡æ•°åˆ†å¸ƒ

3. **LLM Judgeç¼“å­˜å‡è®¾**ï¼šç›¸åŒresponseæ˜¯å¦ç›´æ¥è¿”å›ç¼“å­˜ï¼Ÿ
   - æ£€æŸ¥ï¼šåœ¨Judgeä¸­æ·»åŠ ç¼“å­˜å‘½ä¸­æ—¥å¿—

4. **ç†µè®¡ç®—bugå‡è®¾**ï¼šç†µå€¼0.2-0.5æ˜¯å¦å‡†ç¡®ï¼Ÿ
   - æ£€æŸ¥ï¼šæ‰‹åŠ¨è®¡ç®—å‡ ä¸ªæ ·æœ¬çš„ç†µï¼ŒéªŒè¯ä»£ç æ­£ç¡®æ€§
